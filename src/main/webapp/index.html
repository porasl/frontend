<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>I N R I K</title>
<link rel="icon" href="resources/images/inrik_logo3_white.png">
<link href="/resources/css/bootstrap/5.3/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
	rel="stylesheet">
<link href="/resources/css/inrik.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/resources/js/bootstrap/5.3/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
#uploadSpinnerOverlay {
	position: absolute;
	top: 500;
	left: 500;
	z-index: 1055;
	width: 100%;
	height: 100%;
	background-color: rgba(255, 255, 255, 0.6);
	display: none;
	justify-content: center;
	align-items: center;
}
</style>
</head>

<body>
	<nav
		class="tabs navbar d-flex justify-content-between align-items-center flex-wrap w-100">
		<div id="topLinksSection" class="d-flex align-items-center gap-3">
			<li class="nav-item"><a class="navbar-brand d-flex"
				href="index.html"> <img
					src="resources/images/inrik_logo3_white.png" alt="Logo"
					class="logo">
			</a></li>
			<li class="nav-item"><a href="#" data-bs-toggle="modal"
				data-bs-target="#registerModal" class="top-link">Create Account</a></li>
			<li class="nav-item"><a href="#" data-bs-toggle="modal"
				data-bs-target="#forgotModal" class="top-link">Forgot Password</a></li>
			<li class="nav-item"><a href="#" data-bs-toggle="modal"
				data-bs-target="#activateModal" class="top-link">Activate
					Account</a></li>
		</div>

		<div class="d-flex align-items-center gap-3">
			<div id="loginSection" class="login-form">
				<form id="loginForm">
					<input name="email" type="text"
						class="form-control form-control-sm" placeholder="Email" required>
					<input name="password" type="password"
						class="form-control form-control-sm" placeholder="Password"
						required>
					<button class="btn btn-sm btn-primary" type="submit">Login</button>
				</form>
			</div>

			<div id="userSection"
				class="d-none d-flex justify-content-between align-items-center w-100 px-3">
				<!-- Left-aligned section -->
				<div class="d-flex align-items-center gap-3">
					<li><img src="resources/images/inrik_logo3_white.png"
						alt="Logo" class="logo me-2" style="height: 40px;"></li>
					<li class="nav-item"><img src="resources/images/myContent.png"
						alt="My Contents" onclick="showMyContent()" class="me-2"
						style="height: 40px;"></li>
					<li class="nav-item">
					<img src="resources/images/add.png"
						alt="Add" class="me-2" style="height: 40px; cursor: pointer;"
						data-bs-toggle="modal" data-bs-target="#uploadModal"></li>
					<li class="nav-item"><a href="#" class="top-link"
						onclick="showBazaar()">Bazaar Today</a></li>
				</div>

				<!-- Right-aligned user info section -->
				<div class="d-flex align-items-center gap-2">
					<li class="nav-item"><font size="2"><span id="userName"
							class="me-2"></span></font></li>
					<li class="nav-item"><img id="logoutIcon"
						src="resources/images/logout.png" alt="Logout"
						style="width: 24px; height: 24px; cursor: pointer;"></li>
				</div>
			</div>

		</div>
	</nav>

	<div id="myContents-container" class="d-none"
		style="padding: 100px; padding-left: 150px">
		<h2>Welcome to My Contents</h2>
		<p>Here is your custom content area.</p>
	</div>


	<div id="iframe-container" class="d-none">
		<iframe src="https://bazaartoday.com" width="100%" height="1000px"
			frameborder="0" style="border: none;"></iframe>
	</div>

	<div class="leftbar">
		<ul class="nav flex-column">
			<li class="nav-item"></li>
			<br>
			<li class="nav-item"><a class="nav-link" href=""><img
					src="resources/images/home.png" width="40px"></a></li>
			<li class="nav-item"><a class="nav-link" href=""><img
					src="resources/images/video.png" width="40px"></a></li>
			<li class="nav-item"><a class="nav-link" href=""><img
					src="resources/images/cut.png" width="60px"></a></li>
			<li class="nav-item"><a class="nav-link" href=""><img
					src="resources/images/music.png" width="40px"></a></li>
			<li class="nav-item"><a class="nav-link" href="#"
				data-bs-toggle="modal" data-bs-target="#uploadModal"> <img
					src="resources/images/upload.png" width="40px">
			</a></li>
			<li class="nav-item"><a class="nav-link" href=""><img
					src="resources/images/photo.png" width="40px"></a></li>
			<li class="nav-item"><a class="nav-link" href="#"><img
					src="resources/images/memoryNotes.png" width="40px"></a></li>
			<li class="nav-item"><a class="nav-link" href=""><img
					src="resources/images/profile.png" width="40px"></a></li>
		</ul>
	</div>

	<div id="app-container">
		<div class="main-content">
		
         <video id="test" controls width="640" height="360"> </video>

			<div id="railVideosSection">
				<div class="video-scroll-wrapper">
					<button class="scroll-btn" id="scroll-prev">&#9664;</button>
					<div class="video-scroll-track" id="videoScrollTrack">
						<video id="railVideo1" src="http://localhost:3000/videos/nika.mp4"
							controls class="scroll-video"></video>
						<video id="railVideo2" src="http://localhost:3000/videos/nika.mp4"
							controls class="scroll-video"></video>
						<video id="railVideo3" src="http://localhost:3000/videos/nika.mp4"
							controls class="scroll-video"></video>
						<video id="railVideo4" src="http://localhost:3000/videos/nika.mp4"
							controls class="scroll-video"></video>
						<video id="railVideo5" src="http://localhost:3000/videos/nika.mp4"
							controls class="scroll-video"></video>
						<video id="railVideo6" src="http://localhost:3000/videos/nika.mp4"
							controls class="scroll-video"></video>
						<video id="railVideo7" src="http://localhost:3000/videos/nika.mp4"
							controls class="scroll-video"></video>
						<video id="railVideo8" src="http://localhost:3000/videos/nika.mp4"
							controls class="scroll-video"></video>
						<video id="railVideo9" src="http://localhost:3000/videos/nika.mp4"
							controls class="scroll-video"></video>
						<video id="railVideo10"
							src="http://localhost:3000/videos/nika.mp4" controls
							class="scroll-video"></video>
						<video id="railVideo11"
							src="http://localhost:3000/videos/nika.mp4" controls
							class="scroll-video"></video>
						<video id="railVideo12"
							src="http://localhost:3000/videos/nika.mp4" controls
							class="scroll-video"></video>
					</div>
					<button class="scroll-btn" id="scroll-next">&#9654;</button>
				</div>
			</div>

			<!-- Video Section -->
			<div class="row g-4">
			<div class="col-12 col-md-6 col-xl-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">Featured User Channel</h6>
                            <video src="http://localhost:3000/videos/robin.mp4" controls
                                class="w-100" style="max-height: 300px;"></video>
                        </div>
                    </div>
                </div>
			
			
			
				<div class="col-12 col-md-6 col-xl-4">
					<div class="card h-100">
						<div class="card-body">
							<h6 class="card-title">Featured User Channel</h6>
							<video src="http://localhost:3000/videos/robin.mp4" controls
								class="w-100" style="max-height: 300px;"></video>
						</div>
					</div>
				</div>
				<div class="col-12 col-md-6 col-xl-4">
					<div class="card h-100">
						<div class="card-body">
							<h6 class="card-title">Space Exploration</h6>
							<video src="http://localhost:3000/videos/long2.mp4" controls
								class="w-100" style="max-height: 300px;"></video>
						</div>
					</div>
				</div>
				<div class="col-12 col-md-6 col-xl-4">
					<div class="card h-100">
						<div class="card-body">
							<h6 class="card-title">Nature Wonders</h6>
							<video src="http://localhost:3000/videos/long1.mp4" controls
								class="w-100" style="max-height: 300px;"></video>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div class="card video-card">
						<div class="card-body">
							<h6 class="card-title">Allie Sherlock & Fabio Rodrigues</h6>
							<video id="video4" src="http://localhost:3000/videos/song1.mp4"
								controls class="w-100"></video>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div class="card video-card">
						<div class="card-body">
							<h6 class="card-title">Space</h6>
							<video id="video5" src="http://localhost:3000/videos/space1.mp4"
								controls class="w-100"></video>
						</div>
					</div>
				</div>
				<div class="col-md-4">
					<div class="card video-card">
						<div class="card-body">
							<h6 class="card-title">Flowers</h6>
							<video id="video6"
								src="http://localhost:3000/videos/flowers1.mp4" controls
								class="w-100"></video>
						</div>
						<!-- Repeat similar video cards for others -->
					</div>
				</div>
			</div>
		</div>

		<!-- Modals -->
		<!-- Register Modal -->
		<div class="modal fade" id="registerModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Create Account</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body" id="registerModalBody">
						<form id="registerForm">
							<input type="text" class="form-control mb-2" name="firstname"
								placeholder="First Name" required> <input type="text"
								class="form-control mb-2" name="lastname"
								placeholder="Last Name" required> <input type="password"
								class="form-control mb-2" name="password" placeholder="Password"
								required> <input type="password"
								class="form-control mb-2" name="confirmPassword"
								placeholder="Confirm Password" required> <input
								type="email" class="form-control mb-2" name="email"
								placeholder="Email" required> <input type="text"
								class="form-control mb-2" name="role" placeholder="USER"
								required>
							<button type="submit" class="btn btn-primary w-100">Register</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<!-- Forgot Password Modal -->
		<div class="modal fade" id="forgotModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Forgot Password</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<form id="forgotPasswordForm">
							<input type="email" class="form-control mb-2" name="email"
								placeholder="Enter your email" required>
							<button type="submit" class="btn btn-primary w-100">Reset
								Password</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<!-- Activate Account Modal -->
		<div class="modal fade" id="activateModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Activate Account</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="activateAccountForm">
							<input type="text" class="form-control mb-2"
								name="activationCode" placeholder="Enter Activation Code"
								required>
							<button type="submit" class="btn btn-primary w-100">Activate
								Account</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div id="uploadSpinnerOverlay">
			<div class="spinner-border text-primary" role="status"
				style="width: 3rem; height: 3rem;">
				<span class="visually-hidden">Uploading...</span>
			</div>
		</div>

		<!-- Upload Modal -->
<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content rounded">
      <div class="modal-header justify-content-between">
        <h5 class="modal-title" id="uploadModalLabel">Create a Post</h5>
        <button type="button" class="close" onclick="$('#uploadModal').modal('hide')" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <div class="row">
            <!-- Left Column: Options -->
            <div class="col-md-2">
              <div id='publicPost'>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="memorySwitch" onclick="displayMemeory(this.id)">
                  <label class="form-check-label" for="memorySwitch">Memory</label>
                </div>
                <div id="memeoryDateTd" style="display: none">
                  <input type="text" id="memeoryDatepickerId" class="form-control form-control-sm">
                </div>

                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="eventSwitch" onclick="displayEvent(this.id)">
                  <label class="form-check-label" for="eventSwitch">Event</label>
                </div>
                <div id="eventDateTd" style="display: none">
                  <input type="text" id="eventDatepickerId" class="form-control form-control-sm">
                </div>

                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="publicSwitch" checked>
                  <label class="form-check-label" for="publicSwitch">Public</label>
                </div>
              </div>
            </div>

            <!-- Right Column: Upload + Display + Buttons -->
            <div class="col-md-10">
              <div id="dropZone" class="border rounded p-3 mb-3 text-center" style="min-height: 200px;">
                <p>Drag & Drop files here</p>
                <form class="my-form">
                  <input type="file" id="fileElem" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt" style="display:none" onchange="handleFilesPost(this.files)">
                  <div id="fileNameDisplay"></div>
                  <label for="fileElem" class="btn btn-outline-dark">Browse</label>
                </form>
              </div>
             
              <div id="videoAttach" class="mb-2"></div>
              <div id="imageAttach" class="mb-2"></div>
              <div id="audioAttach" class="mb-2"></div>
              <div id="otherAttach" class="mb-2"></div>

              <div class="d-flex justify-content-end mt-4">
                <button type="button" class="btn btn-outline-secondary mr-2" onclick="$('#uploadModal').modal('hide')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendThePost()">Post</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

		


		<!-- JavaScript -->
		<script>
document.addEventListener("DOMContentLoaded", function () {
  ['forgotModal', 'activateModal'].forEach(id => {
    const modal = document.getElementById(id);
    if (modal) new bootstrap.Modal(modal);
  });

  const registerForm = document.getElementById("registerForm");
  const registerModalBody = document.getElementById("registerModalBody");
  const loginForm = document.getElementById("loginForm");
  const loginSection = document.getElementById("loginSection");
  const userSection = document.getElementById("userSection");
  const userNameSpan = document.getElementById("userName");
  const logoutIcon = document.getElementById("logoutIcon");
  const topLinksSection = document.getElementById("topLinksSection");
  const railVideosSection = document.getElementById("railVideosSection");

  if (registerForm) {
    registerForm.addEventListener("submit", function (event) {
      event.preventDefault();
      const formData = Object.fromEntries(new FormData(registerForm));

      fetch("http://localhost:8082/api/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData),
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => { throw new Error(data.message || "Registration failed."); });
        }
        return response.json();
      })
      .then(() => {
        registerModalBody.innerHTML = `<div class="alert alert-success text-center"><strong>User is created!</strong> An email has been sent to <strong>${formData.email}</strong> with activation instructions.</div>`;
      })
      .catch(error => {
        console.error("Registration error:", error);
        alert(error.message || "Registration failed. Please try again.");
      });
    });
  }

  function updateUI() {
    const token = localStorage.getItem("token");
    const userName = localStorage.getItem("userName");

    if (token && userName) {
      loginSection.classList.add("d-none");
      userSection.classList.remove("d-none");
      userNameSpan.textContent = userName;
      topLinksSection.classList.add("d-none");
      railVideosSection.classList.remove("d-none");
    } else {
      loginSection.classList.remove("d-none");
      userSection.classList.add("d-none");
      userNameSpan.textContent = "";
      topLinksSection.classList.remove("d-none");
      railVideosSection.classList.add("d-none");
    }
  }

  if (loginForm) {
    loginForm.addEventListener("submit", function (event) {
      event.preventDefault();
      const formData = new FormData(loginForm);
      const email = formData.get("email");
      const password = formData.get("password");

      fetch("http://localhost:8080/auth/authenticate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      })
      .then(response => {
        if (!response.ok) {
          throw new Error("Invalid login credentials");
        }
        return response.json();
      })
      .then(data => {
        localStorage.setItem("token", data.access_token);
        localStorage.setItem("refresh_token", data.refresh_token);
        localStorage.setItem("userName", email);
        localStorage.setItem("userId", email);
        localStorage.setItem("postId", data.postId);
        
        updateUI();
        window.location.href = "/dashboard";
      })
      .catch(error => {
        console.error("Login failed:", error);
        alert("Login failed. Please check your credentials.");
      });
    });
  }

  if (logoutIcon) {
    logoutIcon.addEventListener("click", function () {
      localStorage.removeItem("token");
      localStorage.removeItem("refresh_token");
      localStorage.removeItem("userName");
      updateUI();
      window.location.href = "/";
    });
  }

  updateUI();
});

function showBazaar() {
	  document.getElementById("iframe-container").classList.remove("d-none");
	  document.getElementById("app-container").classList.add("d-none");
	  document.getElementById("myContents-container").classList.add("d-none");
	}

	function showApp() {
	  document.getElementById("iframe-container").classList.add("d-none");
	  document.getElementById("app-container").classList.remove("d-none");
	  document.getElementById("myContents-container").classList.add("d-none");
	}

	function showMyContent() { console.log("ðŸ” showMyContent called");
	  document.getElementById("myContents-container").classList.remove("d-none");
	  document.getElementById("iframe-container").classList.add("d-none");
	  document.getElementById("app-container").classList.add("d-none");
	}

	document.addEventListener("DOMContentLoaded", function () {
		  const scrollTrack = document.getElementById("videoScrollTrack");
		  const prevBtn = document.getElementById("scroll-prev");
		  const nextBtn = document.getElementById("scroll-next");

		  const scrollAmount = () => {
		    const video = scrollTrack.querySelector(".scroll-video");
		    return video.offsetWidth + 10; // gap is 10px
		  };

		  nextBtn.addEventListener("click", () => {
		    scrollTrack.scrollBy({ left: scrollAmount(), behavior: 'smooth' });
		  });

		  prevBtn.addEventListener("click", () => {
		    scrollTrack.scrollBy({ left: -scrollAmount(), behavior: 'smooth' });
		  });
		});

    
//Upload Modal
document.addEventListener("DOMContentLoaded", function () {
  const dropZone = document.getElementById("dropZone");
  const fileInput = document.getElementById("fileInput");
  const fileNameDisplay = document.getElementById("fileName");
  const uploadForm = document.getElementById("uploadForm");

  // Drag-and-drop handlers
  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("bg-light");
  }); 

  $(document).ready(function () {
	  
	 
  var videoDiv = document.getElementById('test');
  var hls = new Hls({
  debug: false    
  });
  hls.loadSource('http://localhost:3000/videos/1747552911568_test2/stream.m3u8');
  hls.attachMedia(videoDiv);
  
  hls.on(Hls.Events.MEDIA_ATTACHED, function() {
  videoDiv.muted = true;
  videoDiv.autoplay='autoplay';
  videoDiv.loop='loop';
  videoDiv.muted='muted';
  videoDiv.play();
	}); 
	         
	        
	    
	});
});

</script>

<script>
  const dropZone = document.getElementById("dropZone");
  const fileInput = document.getElementById("fileElem");
  const postIdField = document.getElementById("postid");
  
  const MAX_SIZE_MB = 500;

  // Prevent default drag behaviors
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, e => {
      e.preventDefault();
      e.stopPropagation();
    }, false);
  });

  // Highlight on drag
  dropZone.addEventListener("dragover", () => {
    dropZone.classList.add("bg-light");
  });


  dropZone.addEventListener("drop", (e) => {
	    e.preventDefault();
	    dropZone.classList.remove("bg-light");
	    const file = e.dataTransfer.files[0];
	    if (file) handleFileSelect(file);
	  });

	  fileInput.addEventListener("change", (e) => {
	    const file = e.target.files[0];
	    if (file) handleFileSelect(file);
	  });

	  function handleFileSelect(file) {
	    const maxBytes = MAX_SIZE_MB * 1024 * 1024;
	    //var dropZone = "";
	    
	    if (file.size > maxBytes) {
	      alert("File exceeds the 100MB size limit.");
	      fileInput.value = "";
	      fileNameDisplay.textContent = "";
	      return;
	    }
	    const dt = new DataTransfer();
	    dt.items.add(file);
	    fileInput.files = dt.files;
	    fileNameDisplay.textContent = file.name;
	  }
  
  dropZone.addEventListener("dragleave", () => {
    dropZone.classList.remove("bg-light");
  });

  // Handle drop
  dropZone.addEventListener("drop", e => {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFilesPost(files); // Optional: display file info
      uploadFile(files[0]);
    }
  });

  // Handle file upload
  function uploadFile(file) {debugger
    const formData = new FormData();
    const userId = localStorage.getItem("userId");
    const postId = localStorage.getItem("postCode");
    formData.append("file", file);
    formData.append("userId", userId);
    formData.append("postCode", postCode);

  fetch("http://localhost:8082/api/upload", {
    method: "POST",
    body: formData
  })
  .then(res => res.json())
  .then(data => { debugger;
  localStorage.setItem("userName", data.email);
  localStorage.setItem("postCode", data.postId);
    if (data.filename) {
      dirname = data.filename.split(".")[0];
      filepath = "http://localhost:3000/videos/tmp/" + data.filename;
      console.log("âœ… Uploaded. filepath:", filepath);
      previewFile(file, filepath);
    } else {
      alert("Upload succeeded, but no post Code returned.");
    }
  })
  .catch(err => {
    console.error("Upload error:", err);
    alert("File upload failed.");
  });
}

  // Display preview
  function previewFile(file, videopath) {
    const type = file.type;
    const reader = new FileReader();

    reader.onload = function (e) {
      let html = "";
      if (type.startsWith("video/mp4")) {
          html = `<video src=`+ videopath + ` controls width=300 height=200>`;
          $("#videoAttach").append(html);
        } 
      else if (type.startsWith("image/")) {
        html = `<img src="${e.target.result}" class="img-thumbnail mr-2" style="max-height:100px;">`;
        $("#imageAttach").append(html);
      } else if (type.startsWith("audio/")) {
        html = `<audio controls src="${e.target.result}" class="mr-2"></audio>`;
        $("#audioAttach").append(html);
      } else {
        html = `<p><i class="fa fa-file mr-1"></i> ${file.name}</p>`;
        $("#otherAttach").append(html);
      }
    };

    reader.readAsDataURL(file);
  }

  // Optional: Support manual file selection
  function handleFilesPost(files) {
    if (files.length > 0) {
      uploadFile(files[0]); // Trigger upload manually
    }
  }
</script>
<video id="previewVideo" width="480" height="270" controls style="display: none;">
  <source id="videoSource" src="" type="application/vnd.apple.mpegurl">
  Your browser does not support the video tag.
</video>
<div id="videoMessage" class="mt-2 text-danger" style="display: none;"></div>

</body>
</html>
